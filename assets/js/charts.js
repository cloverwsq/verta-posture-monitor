/**
 * VertA Charts Initialization with Chart.js
 * Note: Main timeline chart is now handled by improved-timeline.js
 * This file handles other charts like weekly progress
 * Fixed: Animation, scroll issues, and container problems
 * Version: 2.0 - Container Fix
 */

let weeklyChart;
let chartUpdateInterval;

function initCharts() {
    console.log('üìä Initializing charts...');
    
    try {
        // The main posture timeline is now handled by improved-timeline.js
        // We only initialize other charts here
        
        initWeeklyProgressChart();
        startChartUpdates();
        console.log('‚úÖ Charts initialized successfully');
    } catch (error) {
        console.error('‚ùå Chart initialization failed:', error);
    }
}

function initWeeklyProgressChart() {
    const ctx = document.getElementById('weekly-chart');
    if (!ctx) {
        console.warn('‚ö†Ô∏è Weekly chart canvas not found');
        return;
    }

    // üîç Ê£ÄÊü•Âπ∂Á°Æ‰øùÂÆπÂô®Ê≠£Á°Æ
    let container = ctx.parentElement;
    
    // Ê£ÄÊü•Áà∂ÂÖÉÁ¥†ÊòØÂê¶ÊòØÂêàÈÄÇÁöÑÂÆπÂô®
    const isSuitableContainer = container && 
                                 container.tagName !== 'BODY' && 
                                 container.tagName !== 'HTML' &&
                                 (container.classList.contains('chart-container') || 
                                  container.classList.contains('chart-wrapper') ||
                                  container.id === 'weekly-chart-container');
    
    if (!isSuitableContainer) {
        console.warn('‚ö†Ô∏è Canvas not in proper container, creating wrapper...');
        
        // ÂàõÂª∫ÂêàÈÄÇÁöÑÂÆπÂô®
        const wrapper = document.createElement('div');
        wrapper.className = 'chart-container weekly-chart-container';
        wrapper.id = 'weekly-chart-container';
        
        // Â∞Ü canvas ÂåÖË£πËµ∑Êù•
        if (ctx.parentNode) {
            ctx.parentNode.insertBefore(wrapper, ctx);
            wrapper.appendChild(ctx);
        }
        
        container = wrapper;
        console.log('‚úÖ Created proper container for weekly chart');
    }

    // üîí Âõ∫ÂÆöÂÆπÂô®ÂíåÁîªÂ∏ÉÂ∞∫ÂØ∏ÔºàÁ°Æ‰øùÂõæË°®Âú®ÂÆπÂô®ÂÜÖÔºâ
    if (container) {
        // === ÂÆπÂô®Ê†∑Âºè ===
        container.style.position = 'relative';
        container.style.minHeight = '350px';
        container.style.height = '350px';
        container.style.width = '100%';
        container.style.maxWidth = '100%';
        container.style.padding = '20px 10px';
        container.style.margin = '0 auto';
        container.style.boxSizing = 'border-box';
        container.style.overflow = 'hidden'; // ‚úÖ Èò≤Ê≠¢Ê∫¢Âá∫
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        
        // === Canvas Ê†∑Âºè ===
        ctx.style.display = 'block';
        ctx.style.maxWidth = '100%';
        ctx.style.maxHeight = '100%';
        ctx.style.width = '100%';
        ctx.style.height = 'auto';
        
        console.log('‚úÖ Container and canvas styles applied');
        console.log('üìè Container:', {
            tag: container.tagName,
            id: container.id,
            classes: container.className,
            width: container.offsetWidth,
            height: container.offsetHeight
        });
    }

    const weeklyData = generateWeeklyData();

    weeklyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Daily Average Score',
                data: weeklyData,
                backgroundColor: [
                    'rgba(255, 107, 107, 0.8)',
                    'rgba(78, 205, 196, 0.8)',
                    'rgba(69, 183, 209, 0.8)',
                    'rgba(150, 206, 180, 0.8)',
                    'rgba(254, 202, 87, 0.8)',
                    'rgba(255, 159, 243, 0.8)',
                    'rgba(84, 160, 255, 0.8)'
                ],
                borderColor: [
                    '#ff6b6b',
                    '#4ecdc4',
                    '#45b7d1',
                    '#96ceb4',
                    '#feca57',
                    '#ff9ff3',
                    '#54a0ff'
                ],
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    right: 15,
                    bottom: 10,
                    left: 15
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: '#4ecdc4',
                    borderWidth: 1,
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    cornerRadius: 10,
                    callbacks: {
                        label: function(context) {
                            return `Daily Score: ${context.parsed.y}%`;
                        },
                        afterLabel: function(context) {
                            const score = context.parsed.y;
                            if (score >= 90) return 'üèÜ Excellent day!';
                            if (score >= 80) return 'üëç Good day';
                            if (score >= 70) return '‚ö†Ô∏è Could be better';
                            return '‚ùå Needs improvement';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#fff',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    min: 0,
                    max: 105,
                    ticks: {
                        color: '#fff',
                        font: {
                            size: 11
                        },
                        stepSize: 20,
                        callback: function(value) {
                            return value <= 100 ? value + '%' : '';
                        }
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.1)'
                    }
                }
            },
            interaction: {
                intersect: false
            },
            elements: {
                bar: {
                    borderWidth: 2
                }
            },
            // ‚úÖ ÂÆåÂÖ®Á¶ÅÁî®Âä®Áîª
            animation: {
                duration: 0
            },
            transitions: {
                active: {
                    animation: {
                        duration: 0
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const element = elements[0];
                    const dayIndex = element.index;
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    const score = weeklyData[dayIndex];
                    
                    if (window.showToast) {
                        window.showToast(`${days[dayIndex]}: ${score}% average score`, 'info', 3000);
                    }
                }
            }
        }
    });
    
    console.log('‚úÖ Weekly progress chart created (scroll-safe, contained)');
}

function generateWeeklyData() {
    const data = [];
    const today = new Date().getDay(); // 0 = Sunday, 1 = Monday, etc.
    const mondayBasedToday = today === 0 ? 6 : today - 1; // Convert to Monday = 0
    
    for (let day = 0; day < 7; day++) { // Monday to Sunday
        if (day <= mondayBasedToday) {
            // Â∑≤ËøáÂéªÁöÑÂ§©Êï∞
            let score = 75 + Math.random() * 20; // Âü∫Á°ÄÂàÜÊï∞ 75-95
            
            // Âë®Êú´ÂèØËÉΩÂàÜÊï∞Á®ç‰Ωé
            if (day === 5 || day === 6) { // Saturday = 5, Sunday = 6 in Monday-based system
                score -= 5;
            }
            
            // ‰ªäÂ§©ÁöÑÂàÜÊï∞Á®çÂæÆÈ´ò‰∏ÄÁÇπÔºàÁßØÊûÅÂ±ïÁ§∫Ôºâ
            if (day === mondayBasedToday) {
                score += 5;
            }
            
            data.push(Math.round(Math.max(60, Math.min(100, score))));
        } else {
            // Êú™Êù•ÁöÑÂ§©Êï∞
            data.push(null);
        }
    }
    
    return data;
}

function startChartUpdates() {
    // Ê∏ÖÈô§Â∑≤Â≠òÂú®ÁöÑÂÆöÊó∂Âô®
    if (chartUpdateInterval) {
        clearInterval(chartUpdateInterval);
    }
    
    // ÊØèÂ∞èÊó∂Êõ¥Êñ∞‰∏ÄÊ¨°Âë®ÂõæË°®ÔºàÂü∫‰∫éÂΩìÂ§©ÁöÑË°®Áé∞Ôºâ
    chartUpdateInterval = setInterval(() => {
        updateWeeklyChart();
    }, 60 * 60 * 1000); // ÊØèÂ∞èÊó∂
    
    console.log('üìà Chart update interval started (1 hour)');
}

function updateWeeklyChart() {
    if (!weeklyChart) return;
    
    // üîí ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
    const scrollPos = window.scrollY;
    
    try {
        const today = new Date().getDay();
        const mondayBasedToday = today === 0 ? 6 : today - 1;
        
        // ËÆ°ÁÆó‰ªäÂ§©ÁöÑÂπ≥ÂùáÂàÜÊï∞
        let todayScore = 80;
        
        // Â¶ÇÊûúÊúâÊó∂Èó¥Á∫øÊï∞ÊçÆÔºå‰ΩøÁî®ÂÆûÈôÖÊï∞ÊçÆ
        if (window.improvedTimeline) {
            const timelineData = window.improvedTimeline.getCurrentData();
            if (timelineData && timelineData.length > 0) {
                const validData = timelineData.filter(score => score !== null && score !== undefined);
                if (validData.length > 0) {
                    todayScore = Math.round(validData.reduce((a, b) => a + b, 0) / validData.length);
                }
            }
        }
        
        // ÊàñËÄÖ‰ΩøÁî®MLÊ®°ÂûãÁöÑÂπ≥ÂùáÂàÜÊï∞
        if (window.mlModel) {
            const stats = window.mlModel.getStatistics();
            if (stats && stats.averageConfidence) {
                todayScore = Math.round(stats.averageConfidence * 100);
            }
        }
        
        // Êõ¥Êñ∞Êï∞ÊçÆ
        weeklyChart.data.datasets[0].data[mondayBasedToday] = todayScore;
        
        // ‚úÖ ‰ΩøÁî® 'none' Ê®°ÂºèÊõ¥Êñ∞ÔºåÂÆåÂÖ®Êó†Âä®Áîª
        weeklyChart.update('none');
        
        console.log(`üìä Updated weekly chart for today: ${todayScore}%`);
    } catch (error) {
        console.error('Error updating weekly chart:', error);
    }
    
    // üîì ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
    requestAnimationFrame(() => {
        window.scrollTo(0, scrollPos);
    });
}

// ÊâãÂä®Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆÔºà‰øùÊåÅÊªöÂä®‰ΩçÁΩÆÔºâ
function updateWeeklyChartData(dayIndex, score) {
    if (!weeklyChart || dayIndex < 0 || dayIndex >= 7) return;
    
    const scrollPos = window.scrollY;
    
    weeklyChart.data.datasets[0].data[dayIndex] = Math.round(score);
    weeklyChart.update('none'); // Êó†Âä®ÁîªÊõ¥Êñ∞
    
    // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
    requestAnimationFrame(() => {
        window.scrollTo(0, scrollPos);
    });
}

// Ëé∑ÂèñÂë®ÂõæË°®Êï∞ÊçÆ
function getWeeklyData() {
    return weeklyChart ? weeklyChart.data.datasets[0].data : null;
}

// ÈáçÁΩÆÂõæË°®Êï∞ÊçÆ
function resetCharts() {
    if (!weeklyChart) return;
    
    const scrollPos = window.scrollY;
    
    weeklyChart.data.datasets[0].data = generateWeeklyData();
    weeklyChart.update('none');
    
    // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
    requestAnimationFrame(() => {
        window.scrollTo(0, scrollPos);
    });
    
    console.log('üîÑ Charts data reset');
}

// ÈîÄÊØÅÂõæË°®ÔºàÊ∏ÖÁêÜËµÑÊ∫êÔºâ
function destroyCharts() {
    if (chartUpdateInterval) {
        clearInterval(chartUpdateInterval);
        chartUpdateInterval = null;
    }
    
    if (weeklyChart) {
        weeklyChart.destroy();
        weeklyChart = null;
    }
    
    console.log('üóëÔ∏è Charts destroyed');
}

// ÂõæË°®Âä®ÁîªÊéßÂà∂Ôºà‰∏ÄËà¨‰∏ç‰ΩøÁî®Ôºå‰øùÁïôÂêëÂêéÂÖºÂÆπÔºâ
function animateChart(chart, duration = 0) {
    if (!chart) return;
    
    // ÈªòËÆ§Á¶ÅÁî®Âä®Áîª‰ª•ÈÅøÂÖçÊªöÂä®ÈóÆÈ¢ò
    chart.options.animation.duration = duration;
    chart.update(duration > 0 ? 'active' : 'none');
}

// üîß ËØäÊñ≠Â∑•ÂÖ∑ÔºöÊ£ÄÊü•ÂõæË°®ÂÆπÂô®Áä∂ÊÄÅ
function diagnoseChartContainer() {
    const canvas = document.getElementById('weekly-chart');
    
    if (!canvas) {
        console.error('‚ùå Canvas #weekly-chart not found!');
        return null;
    }
    
    const container = canvas.parentElement;
    const diagnosis = {
        canvas: {
            id: canvas.id,
            width: canvas.offsetWidth,
            height: canvas.offsetHeight,
            display: window.getComputedStyle(canvas).display,
            position: window.getComputedStyle(canvas).position
        },
        container: {
            tag: container?.tagName,
            id: container?.id,
            classes: container?.className,
            width: container?.offsetWidth,
            height: container?.offsetHeight,
            overflow: container ? window.getComputedStyle(container).overflow : null,
            display: container ? window.getComputedStyle(container).display : null
        },
        isProperlyContained: container?.classList.contains('chart-container') || 
                            container?.classList.contains('chart-wrapper') ||
                            container?.id === 'weekly-chart-container',
        chartExists: !!weeklyChart,
        chartData: weeklyChart ? weeklyChart.data.datasets[0].data : null
    };
    
    console.log('üìä Chart Container Diagnosis:');
    console.table(diagnosis);
    
    if (!diagnosis.isProperlyContained) {
        console.warn('‚ö†Ô∏è Chart may not be properly contained!');
        console.log('üí° Tip: Run initWeeklyProgressChart() to auto-fix');
    } else {
        console.log('‚úÖ Chart is properly contained');
    }
    
    return diagnosis;
}

// ÂØºÂá∫ÂáΩÊï∞
window.initCharts = initCharts;
window.updateWeeklyChartData = updateWeeklyChartData;
window.updateWeeklyChart = updateWeeklyChart;
window.getWeeklyData = getWeeklyData;
window.resetCharts = resetCharts;
window.destroyCharts = destroyCharts;
window.animateChart = animateChart;
window.diagnoseChartContainer = diagnoseChartContainer;

// ‰∏∫ÂêëÂêéÂÖºÂÆπÔºå‰øùÁïôËøô‰∫õÂáΩÊï∞
window.initWeeklyChart = initWeeklyProgressChart;

// Chart.js ÂÖ®Â±ÄÈÖçÁΩÆ
if (typeof Chart !== 'undefined') {
    // ÂÖ®Â±ÄÂ≠ó‰ΩìËÆæÁΩÆ
    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, sans-serif";
    Chart.defaults.color = '#ffffff';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    
    // ‚úÖ ÂÖ®Â±ÄÁ¶ÅÁî®Âä®ÁîªÔºàÈò≤Ê≠¢ÊâÄÊúâÂõæË°®Âá∫Áé∞ÊªöÂä®ÈóÆÈ¢òÔºâ
    Chart.defaults.animation = {
        duration: 0
    };
    Chart.defaults.transitions = {
        active: {
            animation: {
                duration: 0
            }
        }
    };
    
    // Ê≥®ÂÜåÂÖ®Â±ÄÊèí‰ª∂
    Chart.register({
        id: 'vertaTheme',
        beforeDraw: (chart) => {
            const ctx = chart.ctx;
            ctx.save();
            
            // Ê∑ªÂä†ÂæÆÂ¶ôÁöÑËÉåÊôØÊ∏êÂèò
            if (chart.config.type === 'bar') {
                const gradient = ctx.createLinearGradient(0, 0, 0, chart.height);
                gradient.addColorStop(0, 'rgba(78, 205, 196, 0.05)');
                gradient.addColorStop(1, 'rgba(255, 107, 107, 0.05)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, chart.width, chart.height);
            }
            
            ctx.restore();
        }
    });
    
    console.log('‚úÖ Chart.js global animations disabled (scroll fix)');
}

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
window.addEventListener('beforeunload', function() {
    destroyCharts();
});

console.log('üìä Charts module loaded v2.0 (scroll-safe + container-fix mode)');